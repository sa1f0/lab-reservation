<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Drone Lab — PC Reservation (OTP Only)</title>

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--brand:#0ea5e9}
    *{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .card{border-radius:1rem;box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
  </style>

  <script>
    /* ===== Supabase client (keep your project keys) ===== */
    const SUPABASE_URL  = 'https://asfjgkvbtxzqibauvwxl.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzZmpna3ZidHh6cWliYXV2d3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTUwODMsImV4cCI6MjA3NzMzMTA4M30.ZKxf7Kz60S_fdQ1qvVffCGD69vuPfBIUn3dyosZ8WQM';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6">
  <div class="flex items-center gap-3">
    <!-- logo placeholder -->
    <div class="w-12 h-12 bg-slate-200 rounded-lg flex items-center justify-center text-slate-500 text-lg font-semibold">
      LOGO
    </div>
    <div>
      <h1 class="text-3xl font-bold tracking-tight">DRONE Lab — PC Reservation</h1>
      <p class="text-sm text-slate-600">
        Click any free slot below. You’ll receive a 6-digit verification code by email; enter it to confirm your booking.
      </p>
    </div>
  </div>

  <!-- banner placeholder -->
  <div class="w-full sm:w-64 h-16 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400 text-xs">
    Banner (coming soon)
  </div>
</header>

<section class="grid md:grid-cols-2 gap-6 mb-6">
  <div class="card bg-white p-4">
    <h2 class="font-semibold text-lg mb-2">Select Date</h2>
    <input id="datePicker" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
    <span class="mt-3 inline-flex items-center gap-2 text-sm">
      <span>Reservations status:</span>
      <span id="openBadge" class="px-2 py-0.5 text-xs rounded-full bg-slate-200 text-slate-800">…</span>
    </span>
    <p id="closedMsg" class="hidden mt-2 text-sm text-rose-600">Reservations are disabled by admin.</p>
  </div>

  <div class="card bg-white p-4">
    <h2 class="font-semibold text-lg mb-2">Your Details</h2>
    <div class="space-y-2">
      <input id="displayName" placeholder="Display name (optional)" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
      <input id="otpEmail" type="email" placeholder="Email for verification" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
    </div>
    <div class="flex items-center gap-2 mt-3">
      <button id="btnOtpSend" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Send 6-digit Code</button>
      <span id="otpSendStatus" class="text-xs text-slate-500"></span>
    </div>
  </div>
</section>


    <!-- Slots grids -->
    <section class="grid md:grid-cols-2 gap-6 mb-6" id="grids">
      <div class="card bg-white p-4 relative">
        <h3 class="font-semibold mb-3">PC-1</h3>
        <div class="grid grid-cols-1 gap-2" id="grid-PC-1"></div>
      </div>
      <div class="card bg-white p-4 relative">
        <h3 class="font-semibold mb-3">PC-2</h3>
        <div class="grid grid-cols-1 gap-2" id="grid-PC-2"></div>
      </div>
    </section>

    <!-- My reservations + Admin day window -->
    <section class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">My reservations (selected date)</h3>
        <p class="text-xs text-slate-500 mb-3">After OTP verification, your bookings appear here automatically; you can cancel them.</p>
        <div class="flex items-center gap-2 mb-3">
          <span id="mineCount" class="text-xs text-slate-500"></span>
        </div>
        <div id="myList" class="divide-y divide-slate-100 text-sm"></div>
      </div>

      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">Admin: Day availability (selected date)</h3>
        <p class="text-xs text-slate-500 mb-3">Set the ONLY bookable window. (We convert your local time to UTC.)</p>
        <div class="flex items-center gap-3 mb-3">
          <label class="text-sm">Start</label>
          <input id="winStart" type="time" class="px-2 py-1 rounded-lg border border-slate-300" value="09:30">
          <label class="text-sm">End</label>
          <input id="winEnd" type="time" class="px-2 py-1 rounded-lg border border-slate-300" value="17:00">
          <button id="btnSaveWindow" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Save</button>
        </div>
        <p class="text-xs text-slate-500">Slots outside this window are disabled (client) and rejected (server).</p>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">Server-backed via Supabase. Email OTP only.</footer>
  </div>

  <!-- Admin modal -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-lg card bg-white p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Admin</h3>
        <button id="closeAdmin" class="px-2 py-1 text-slate-500 hover:text-slate-700">✕</button>
      </div>
      <div id="adminLogin" class="space-y-3">
        <input id="adminEmail" type="email" placeholder="Admin email" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
        <input id="adminPass" type="password" placeholder="Admin password" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
        <div class="flex gap-2 justify-end">
          <button id="btnAdminLogin" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Log in</button>
        </div>
      </div>
      <div id="adminPanel" class="hidden">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <label class="text-sm">Reservations open</label>
            <input id="toggleOpen" type="checkbox" class="h-4 w-4">
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm">Lock PC-1</label>
            <input id="lock1" type="checkbox" class="h-4 w-4">
            <label class="text-sm">Lock PC-2</label>
            <input id="lock2" type="checkbox" class="h-4 w-4">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="border border-slate-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2">Search & remove</h4>
            <input id="searchName" placeholder="Search by display name" class="w-full px-3 py-2 rounded-lg border border-slate-300 mb-2"/>
            <div id="adminList" class="max-h-64 overflow-auto text-sm"></div>
          </div>
          <div class="border border-slate-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2">Actions</h4>
            <button id="btnWipeDay" class="btn px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-500">Clear selected date</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OTP Modal (email code only) -->
  <div id="otpModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-50">
    <div class="w-full max-w-md card bg-white p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Confirm your slot</h3>
        <button id="otpClose" class="px-2 py-1 text-slate-500 hover:text-slate-700">✕</button>
      </div>

      <div class="text-sm text-slate-600 mb-3" id="otpSlotLabel">Slot: —</div>

      <div class="space-y-3">
        <input id="otpEmail" type="email" placeholder="you@htu.edu.jo" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>

        <div class="flex flex-wrap items-center gap-2">
          <button id="btnOtpSend" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Send 6-digit code</button>
          <span id="otpSendStatus" class="text-xs text-slate-500"></span>
        </div>

        <div class="flex items-center gap-2">
          <input id="otpCode" placeholder="Enter code" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
          <button id="btnOtpVerify" class="btn px-3 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-500">Verify & Book</button>
        </div>

        <p class="text-[11px] text-slate-500">We only use your email to confirm this slot. No links or passwords.</p>
      </div>
    </div>
  </div>

  <script>
    /* ===== utils ===== */
    const $  = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
    const pad = (n)=>String(n).padStart(2,'0');
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const toMs = (x)=> new Date(x).getTime();

    /* ===== refs ===== */
    const datePicker = $('#datePicker');
    const slotLenSel = $('#slotLen');
    const openBadge  = $('#openBadge');
    const closedMsg  = $('#closedMsg');

    const grid1 = $('#grid-PC-1');
    const grid2 = $('#grid-PC-2');

    const myList   = $('#myList');
    const mineCount= $('#mineCount');

    const acctNot = $('#acctNot');
    const acctYes = $('#acctYes');
    const whoami  = $('#whoami');
    const displayNameInp = $('#displayName');
    const saveDisplayName = $('#saveDisplayName');
    const btnLogout = $('#btnLogout');

    // Admin modal
    const adminModal = $('#adminModal');
    const btnAdmin = $('#btnAdmin');
    const adminLogin = $('#adminLogin');
    const adminPanel = $('#adminPanel');
    const closeAdmin = $('#closeAdmin');
    const adminEmail = $('#adminEmail');
    const adminPass = $('#adminPass');
    const btnAdminLogin = $('#btnAdminLogin');

    const toggleOpen = $('#toggleOpen');
    const lock1 = $('#lock1');
    const lock2 = $('#lock2');
    const searchName = $('#searchName');
    const adminList = $('#adminList');
    const btnWipeDay = $('#btnWipeDay');

    const winStart = $('#winStart');
    const winEnd   = $('#winEnd');
    const btnSaveWindow = $('#btnSaveWindow');

    // OTP modal
    const otpModal = $('#otpModal');
    const otpClose = $('#otpClose');
    const otpEmail = $('#otpEmail');
    const btnOtpSend = $('#btnOtpSend');
    const otpSendStatus = $('#otpSendStatus');
    const otpCode = $('#otpCode');
    const btnOtpVerify = $('#btnOtpVerify');
    const otpSlotLabel = $('#otpSlotLabel');

    /* ===== state ===== */
    let adminSession = null;
    let clickBusy = false;
    let pendingSlot = null; // { date, pc, startISO, endISO, display_name }
    // default visible window if no rule exists (09:30–17:00)
    let dayWindow = { start_min: 570, end_min: 1020 };

    datePicker.value = todayStr();

    /* ===== backend helpers ===== */
    async function getReservations(date){
      const { data, error } = await supa.from('reservations').select('*').eq('date', date);
      if(error) throw error; return data || [];
    }
    async function getControls(){
      const { data, error } = await supa.from('controls').select('*').eq('id',1).single();
      if(error) throw error; return data;
    }
    async function getDayRule(date){
      const { data, error } = await supa.from('day_rules').select('*').eq('date', date).maybeSingle();
      if(error) throw error; return data;
    }
    async function rpcReserve({ in_date, in_pc, in_start_iso, in_end_iso, in_display_name }){
      const { error } = await supa.rpc('reserve_slot', { in_date, in_pc, in_start_iso, in_end_iso, in_display_name });
      if (error) throw error;
    }
    async function rpcAdmin(action, payload){
      const { data } = await supa.auth.getSession();
      adminSession = data?.session || null;
      if (!adminSession) throw new Error('Admin not logged in');

      if (action === 'setControls') {
        const { error } = await supa.rpc('admin_set_controls', payload);
        if (error) throw error; return;
      }
      if (action === 'removeReservation') {
        const { error } = await supa.rpc('admin_remove_reservation', payload);
        if (error) throw error; return;
      }
      if (action === 'clearDay') {
        const { error } = await supa.rpc('admin_clear_day', payload);
        if (error) throw error; return;
      }
      if (action === 'setDayWindow') {
        const { error } = await supa.rpc('admin_set_day_window', payload);
        if (error) throw error; return;
      }
    }

    /* ===== PC button visuals ===== */
    function updatePcButtons(active) {
      $$('.pcBtn').forEach(btn=>{
        btn.classList.remove('bg-sky-600','bg-violet-600','text-white','ring-2','ring-offset-2','ring-sky-300','ring-violet-300');
        btn.classList.add('bg-white','text-slate-800','border','border-slate-200');
        if (btn.dataset.pc === 'PC-1' && active === 'PC-1') {
          btn.classList.remove('bg-white','border','border-slate-200');
          btn.classList.add('bg-sky-600','text-white','ring-2','ring-offset-2','ring-sky-300');
        }
        if (btn.dataset.pc === 'PC-2' && active === 'PC-2') {
          btn.classList.remove('bg-white','border','border-slate-200');
          btn.classList.add('bg-violet-600','text-white','ring-2','ring-offset-2','ring-violet-300');
        }
      });
    }
    $$('.pcBtn').forEach(b=> b.addEventListener('click', ()=> updatePcButtons(b.dataset.pc)));
    updatePcButtons('PC-1');

    /* ===== slot helpers ===== */
    function generateSlots(date){
      const len = Number(slotLenSel.value);
      const slots=[];
      const s = dayWindow.start_min, e = dayWindow.end_min;
      for(let m=s; m<e; m+=len){
        const d0 = new Date(`${date}T00:00:00Z`);
        const startISO = new Date(d0.getTime() + m*60000).toISOString();
        const endISO   = new Date(d0.getTime() + (m+len)*60000).toISOString();
        slots.push({startISO, endISO});
      }
      return slots;
    }
    const slotLabel = (startISO, endISO)=>{
      const s=new Date(startISO), e=new Date(endISO);
      const f=(d)=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return `${f(s)}–${f(e)}`;
    };
    const maskName = (name)=>{
      if(!name) return 'User';
      if(name.length<=2) return name[0]+"*";
      return name[0] + '*'.repeat(Math.max(1,name.length-2)) + name[name.length-1];
    };
    const listByPC = (resvs, pc)=> resvs.filter(r=>r.pc===pc).sort((a,b)=>a.start_iso.localeCompare(b.start_iso));

    /* ===== account UI ===== */
    async function refreshAuthUI(){
      const { data: { user } } = await supa.auth.getUser();
      if (user) {
        acctNot.classList.add('hidden');
        acctYes.classList.remove('hidden');
        whoami.textContent = user.email || '(no email?)';
        displayNameInp.value = (user.user_metadata?.display_name || '');
      } else {
        acctNot.classList.remove('hidden');
        acctYes.classList.add('hidden');
        whoami.textContent = '';
      }
    }
    btnLogout?.addEventListener('click', async ()=>{
      await supa.auth.signOut();
      await refreshAuthUI();
      await render();
      myList.innerHTML=''; mineCount.textContent='';
    });
    saveDisplayName.addEventListener('click', async ()=>{
      const { data: { user } } = await supa.auth.getUser();
      if(!user) return alert('Sign in first');
      const display_name = (displayNameInp.value||'').trim().slice(0,40);
      const { error } = await supa.auth.updateUser({ data: { display_name }});
      if(error) return alert(error.message);
      alert('Saved name');
      await refreshAuthUI();
    });

    /* ===== OTP modal ===== */
    function openOtpModal(slotInfo){
      pendingSlot = slotInfo;
      otpSlotLabel.textContent = `Slot: ${slotLabel(slotInfo.startISO, slotInfo.endISO)} · ${slotInfo.pc}`;
      otpModal.classList.remove('hidden'); otpModal.classList.add('flex');
      otpEmail.focus();
    }
    function closeOtpModal(){
      otpModal.classList.add('hidden'); otpModal.classList.remove('flex');
      otpSendStatus.textContent = '';
      otpEmail.value = '';
      otpCode.value = '';
      pendingSlot = null;
    }
    otpClose.addEventListener('click', closeOtpModal);

    // Send the OTP **code** email (no links used)
    // Send the OTP **code** email (no magic link)
btnOtpSend.addEventListener('click', async ()=>{
  const email = (otpEmail.value || '').trim();
  if (!email) return alert('Enter your email.');
  otpSendStatus.textContent = 'Sending…';

  const { error } = await supa.auth.signInWithOtp({
    email,
    options: { shouldCreateUser: true } // <-- no emailRedirectTo here
  });

  otpSendStatus.textContent = error ? error.message : 'Code sent. Check your inbox.';
});

// Verify the 6-digit code, then book
btnOtpVerify.addEventListener('click', async ()=>{
  const email = (otpEmail.value||'').trim();
  const token = (otpCode.value||'').trim();
  if (!email || !token) return alert('Enter the code sent to your email.');
  if (!pendingSlot) return alert('No slot pending. Close and try again.');

  const { error } = await supa.auth.verifyOtp({ email, token, type: 'email' });
  if (error) return alert(error.message);

  const display_name = (document.querySelector('#displayName')?.value || '').trim() || null;
  await rpcReserve({
    in_date: pendingSlot.date,
    in_pc: pendingSlot.pc,
    in_start_iso: pendingSlot.startISO,
    in_end_iso: pendingSlot.endISO,
    in_display_name: display_name
  });

  closeOtpModal();
  await render();
  await renderMine();
  alert('Reservation confirmed ✅');
});


    /* ===== rendering ===== */
    async function refreshDayWindow(){
      const date = datePicker.value;
      const rule = await getDayRule(date);
      dayWindow = rule ? { start_min: rule.start_min, end_min: rule.end_min } : { start_min: 570, end_min: 1020 };
      const toHHMM = (m)=> pad(Math.floor(m/60))+':'+pad(m%60);
      winStart.value = toHHMM(dayWindow.start_min);
      winEnd.value   = toHHMM(dayWindow.end_min);
    }

    async function render(){
      const date = datePicker.value;
      const [controls, resvs] = await Promise.all([getControls(), getReservations(date)]);
      await refreshDayWindow();

      openBadge.textContent = controls.open ? 'Open' : 'Closed';
      openBadge.className = 'px-2 py-0.5 text-xs rounded-full ' + (controls.open?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800');
      closedMsg.classList.toggle('hidden', controls.open);

      const slots = generateSlots(date);
      const grids = { 'PC-1': grid1, 'PC-2': grid2 };

      for(const pc of Object.keys(grids)){
        const g = grids[pc]; g.innerHTML='';
        const rByPc = listByPC(resvs, pc);

        for(const sl of slots){
          const r = rByPc.find(x => toMs(x.start_iso) === toMs(sl.startISO));
          const isReserved = !!r;

          const btn=document.createElement('button');
          btn.className = [
            'w-full flex items-center justify-between px-3 py-2 rounded-lg border',
            isReserved
              ? 'bg-slate-200 border-slate-300 text-slate-500 cursor-not-allowed'
              : 'bg-white border-slate-200 hover:bg-slate-50'
          ].join(' ');
          btn.disabled = isReserved;

          btn.innerHTML = `
            <div class="text-left">
              <div class="text-sm font-medium">${slotLabel(sl.startISO, sl.endISO)}</div>
              <div class="text-xs text-slate-500">${pc}</div>
            </div>
            ${isReserved
              ? `<div class="text-right"><div class="text-xs">Reserved by <span>${maskName(r.display_name)}</span></div></div>`
              : `<div class="text-xs text-emerald-700">Available</div>`
            }`;

          if(!isReserved){
            btn.addEventListener('click', async ()=>{
              const { data:{ user } } = await supa.auth.getUser();
              if (user) {
                // already signed in -> reserve immediately
                const display_name = (displayNameInp?.value || '').trim() || null;
                try{
                  await rpcReserve({ in_date: date, in_pc: pc, in_start_iso: sl.startISO, in_end_iso: sl.endISO, in_display_name: display_name });
                  await render(); await renderMine();
                }catch(e){ alert(e.message || 'Error making reservation'); }
              } else {
                // open OTP modal
                const display_name = (displayNameInp?.value || '').trim() || null;
                openOtpModal({ date, pc, startISO: sl.startISO, endISO: sl.endISO, display_name });
              }
            });
          }
          g.appendChild(btn);
        }
      }
    }

    /* ===== My reservations (owner) ===== */
    async function renderMine(){
      myList.innerHTML = '';
      mineCount.textContent = '';
      const { data:{ user } } = await supa.auth.getUser();
      if(!user) { mineCount.textContent = 'Sign in to view'; return; }

      const date = datePicker.value;
      const resvs = await getReservations(date);
      const mine = resvs
        .filter(r => r.user_id === user.id)
        .sort((a,b)=> a.pc.localeCompare(b.pc) || a.start_iso.localeCompare(b.start_iso));

      mineCount.textContent = mine.length ? `${mine.length} found` : 'None found';

      for(const r of mine){
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between py-2';
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-500';
        btn.textContent='Cancel';
        btn.addEventListener('click', async ()=>{
          btn.disabled = true; btn.textContent = 'Cancelling…';
          try{
            const { error } = await supa.from('reservations').delete().eq('id', r.id); // RLS: owner can delete
            if(error) throw error;
            await render(); await renderMine();
          }catch(e){ alert(e.message || 'Cancel failed'); }
          finally { btn.disabled = false; btn.textContent = 'Cancel'; }
        });

        row.innerHTML = `<div><b>${r.pc}</b> · ${slotLabel(r.start_iso, r.end_iso)}</div>`;
        row.appendChild(btn);
        myList.appendChild(row);
      }
    }

    /* ===== admin modal & actions ===== */
    const renderAdminList = async ()=>{
      const date = datePicker.value;
      const resvs = await getReservations(date);
      const q = (searchName.value||'').toLowerCase();
      const rows = resvs
        .filter(r=>!q || (r.display_name||'').toLowerCase().includes(q))
        .sort((a,b)=> a.pc.localeCompare(b.pc) || a.start_iso.localeCompare(b.start_iso));
      adminList.innerHTML='';
      for(const r of rows){
        const div = document.createElement('div');
        div.className='flex items-center justify-between border-b border-slate-100 py-1.5';
        const btn = document.createElement('button');
        btn.className='px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-500';
        btn.textContent='Remove';
        btn.addEventListener('click', async ()=>{
          try{
            await rpcAdmin('removeReservation', { in_id_text: String(r.id) }); // pass as text
            await renderAdminList(); await render(); await renderMine();
          }catch(e){ alert(e.message); }
        });
        div.innerHTML = `<div><b>${r.pc}</b> · ${slotLabel(r.start_iso, r.end_iso)} · ${r.display_name ? maskName(r.display_name) : ''}</div>`;
        div.appendChild(btn);
        adminList.appendChild(div);
      }
    };

    btnAdmin.addEventListener('click', async ()=>{
      const { data } = await supa.auth.getSession();
      adminSession = data.session || null;
      adminModal.classList.remove('hidden'); adminModal.classList.add('flex');
      adminLogin.classList.toggle('hidden', !!adminSession);
      adminPanel.classList.toggle('hidden', !adminSession);
      if (adminSession) {
        try {
          const c = await getControls();
          toggleOpen.checked = !!c.open; lock1.checked = !!c.lock_pc1; lock2.checked = !!c.lock_pc2;
          await renderAdminList();
        } catch (e) {}
      }
    });
    closeAdmin.addEventListener('click', ()=>{
      adminModal.classList.add('hidden'); adminModal.classList.remove('flex');
    });
    btnAdminLogin.addEventListener('click', async ()=>{
      try{
        const { data, error } = await supa.auth.signInWithPassword({ email: adminEmail.value, password: adminPass.value });
        if(error) throw error;
        adminSession = data.session;
        adminLogin.classList.add('hidden'); adminPanel.classList.remove('hidden');
        const c = await getControls();
        toggleOpen.checked = !!c.open; lock1.checked = !!c.lock_pc1; lock2.checked = !!c.lock_pc2;
        await renderAdminList();
      }catch(err){ alert(err.message||'Login failed'); }
    });

    async function applyControlsChange(){
      try{
        await rpcAdmin('setControls', {
          in_open: toggleOpen.checked,
          in_lock1: lock1.checked,
          in_lock2: lock2.checked
        });
        await render(); await renderAdminList(); await renderMine();
      }catch(e){ alert(e.message); }
    }
    toggleOpen.addEventListener('change', applyControlsChange);
    lock1.addEventListener('change', applyControlsChange);
    lock2.addEventListener('change', applyControlsChange);

    btnWipeDay.addEventListener('click', async ()=>{
      const date = datePicker.value;
      if(!confirm('Clear all reservations on '+date+'?')) return;
      try{
        await rpcAdmin('clearDay', { in_date_text: String(date) }); // pass as text
        await renderAdminList(); await render(); await renderMine();
      }catch(e){ alert(e.message); }
    });

    // Save day window: convert picked LOCAL times to UTC minutes for that date
    const toMinutesUTC = (d)=> d.getUTCHours()*60 + d.getUTCMinutes();
    btnSaveWindow.addEventListener('click', async ()=>{
      const date = datePicker.value;
      const [sh, sm] = winStart.value.split(':').map(v=>parseInt(v,10));
      const [eh, em] = winEnd.value.split(':').map(v=>parseInt(v,10));
      const startLocal = new Date(`${date}T${pad(sh)}:${pad(sm)}:00`);
      const endLocal   = new Date(`${date}T${pad(eh)}:${pad(em)}:00`);
      const in_start_min = toMinutesUTC(startLocal);
      const in_end_min   = toMinutesUTC(endLocal);

      try{
        await rpcAdmin('setDayWindow', { in_date: date, in_start_min, in_end_min });
        await render();
        alert('Saved day window.');
      }catch(e){ alert(e.message || 'Failed to save window'); }
    });

    // realtime: auto-refresh when reservations change
    supa.channel('reservations-live')
      .on('postgres_changes', { event: '*', schema:'public', table:'reservations' }, async () => {
        await render(); await renderMine();
      }).subscribe();

    // auth changes
    supa.auth.onAuthStateChange((_event, session)=>{ adminSession = session; refreshAuthUI(); });

    // initial render
    (async ()=>{ await refreshAuthUI(); await render(); await renderMine(); })();
  </script>
</body>
</html>
