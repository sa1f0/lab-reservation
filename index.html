<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drone Lab — PC Reservation (Server-backed)</title>

  <!-- Tailwind (for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === YOUR SUPABASE PROJECT ===
    const SUPABASE_URL = 'https://asfjgkvbtxzqibauvwxl.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzZmpna3ZidHh6cWliYXV2d3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTUwODMsImV4cCI6MjA3NzMzMTA4M30.ZKxf7Kz60S_fdQ1qvVffCGD69vuPfBIUn3dyosZ8WQM';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  </script>

  <style>
    :root{--brand:#0ea5e9}
    *{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .card{border-radius:1rem;box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Drone Lab — PC Reservation</h1>
        <p class="text-sm text-slate-600">Reserve with <b>name</b> + <b>passcode</b>. Admin can control open/lock & removals. Users can cancel their own bookings.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnAdmin" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Admin</button>
      </div>
    </header>

    <!-- Top controls -->
    <section class="grid md:grid-cols-3 gap-6 mb-6">
      <div class="card bg-white p-4">
        <h2 class="font-semibold text-lg mb-2">Date</h2>
        <input id="datePicker" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
        <div class="mt-4 flex gap-2 items-center">
          <label class="text-sm">Slot length</label>
          <select id="slotLen" class="px-2 py-1 rounded-lg border border-slate-300">
            <option value="30" selected>30 min</option>
            <option value="60">60 min</option>
            <option value="90">90 min</option>
            <option value="120">120 min</option>
          </select>
          <label class="text-sm ml-2">Hours</label>
          <!-- defaults: 09:30–17:00; allow half-hours -->
          <input id="startHour" type="number" step="0.5" min="0" max="23.5" value="9.5" class="w-20 px-2 py-1 rounded-lg border border-slate-300">–
          <input id="endHour" type="number" step="0.5" min="0.5" max="24" value="17" class="w-20 px-2 py-1 rounded-lg border border-slate-300">
          <button id="regen" class="ml-auto btn px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Reload</button>
        </div>
        <div class="mt-4 flex items-center gap-3">
          <span class="text-sm">Reservations:</span>
          <span id="openBadge" class="px-2 py-0.5 text-xs rounded-full bg-slate-200 text-slate-800">…</span>
        </div>
        <p id="closedMsg" class="hidden mt-2 text-sm text-rose-600">Reservations are disabled by admin.</p>
      </div>

      <div class="card bg-white p-4">
        <h2 class="font-semibold text-lg mb-2">Your details</h2>
        <div class="grid grid-cols-5 gap-2">
          <input id="inpName" placeholder="Your name" class="col-span-3 px-3 py-2 rounded-lg border border-slate-300"/>
          <input id="inpCode" placeholder="Passcode" class="col-span-2 px-3 py-2 rounded-lg border border-slate-300"/>
        </div>
        <p class="text-xs text-slate-500 mt-2">Limit: up to 60 minutes per day. Use the same passcode to cancel your bookings.</p>
      </div>

      <div class="card bg-white p-4">
        <h2 class="font-semibold text-lg mb-2">PCs</h2>
        <div class="flex gap-2">
          <button data-pc="PC-1" class="pcBtn btn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-100">PC-1</button>
          <button data-pc="PC-2" class="pcBtn btn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-100">PC-2</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Reserved slots are greyed out and cannot be clicked.</p>
      </div>
    </section>

    <!-- Slots grids -->
    <section class="grid md:grid-cols-2 gap-6 mb-6" id="grids">
      <div class="card bg-white p-4 relative">
        <h3 class="font-semibold mb-3">PC-1</h3>
        <div class="grid grid-cols-1 gap-2" id="grid-PC-1"></div>
      </div>
      <div class="card bg-white p-4 relative">
        <h3 class="font-semibold mb-3">PC-2</h3>
        <div class="grid grid-cols-1 gap-2" id="grid-PC-2"></div>
      </div>
    </section>

    <!-- User self-cancel panel -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">My reservations (for selected date)</h3>
        <p class="text-xs text-slate-500 mb-3">Enter your name & passcode above, then click “Find my reservations”. You can cancel your own bookings.</p>
        <div class="flex items-center gap-2 mb-3">
          <button id="btnFindMine" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Find my reservations</button>
          <span id="mineCount" class="text-xs text-slate-500"></span>
        </div>
        <div id="myList" class="divide-y divide-slate-100 text-sm"></div>
      </div>

      <!-- Admin modal trigger lives in header; right column empty for symmetry -->
      <div></div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">Server-backed via Supabase.</footer>
  </div>

  <!-- Admin modal -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-lg card bg-white p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Admin</h3>
        <button id="closeAdmin" class="px-2 py-1 text-slate-500 hover:text-slate-700">✕</button>
      </div>
      <div id="adminLogin" class="space-y-3">
        <input id="adminEmail" type="email" placeholder="Admin email" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
        <input id="adminPass" type="password" placeholder="Admin password" class="w-full px-3 py-2 rounded-lg border border-slate-300"/>
        <div class="flex gap-2 justify-end">
          <button id="btnAdminLogin" class="btn px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Log in</button>
        </div>
      </div>
      <div id="adminPanel" class="hidden">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <label class="text-sm">Reservations open</label>
            <input id="toggleOpen" type="checkbox" class="h-4 w-4">
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm">Lock PC-1</label>
            <input id="lock1" type="checkbox" class="h-4 w-4">
            <label class="text-sm">Lock PC-2</label>
            <input id="lock2" type="checkbox" class="h-4 w-4">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="border border-slate-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2">Search & remove</h4>
            <input id="searchName" placeholder="Search by name" class="w-full px-3 py-2 rounded-lg border border-slate-300 mb-2"/>
            <div id="adminList" class="max-h-64 overflow-auto text-sm"></div>
          </div>
          <div class="border border-slate-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2">Actions</h4>
            <button id="btnWipeDay" class="btn px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-500">Clear selected date</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const $ = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
    const pad = (n)=>String(n).padStart(2,'0');
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const toMs = (x)=> new Date(x).getTime();

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function mkISO(date, hour, min){ return `${date}T${pad(hour)}:${pad(min)}:00Z`; }

    // ===== UI elements =====
    const datePicker = $('#datePicker');
    const slotLenSel = $('#slotLen');
    const startHourInp = $('#startHour');
    const endHourInp = $('#endHour');
    const regenBtn = $('#regen');
    const openBadge = $('#openBadge');
    const closedMsg = $('#closedMsg');

    const nameInp = $('#inpName');
    const codeInp = $('#inpCode');

    const grid1 = $('#grid-PC-1');
    const grid2 = $('#grid-PC-2');

    const adminModal = $('#adminModal');
    const btnAdmin = $('#btnAdmin');
    const adminLogin = $('#adminLogin');
    const adminPanel = $('#adminPanel');
    const closeAdmin = $('#closeAdmin');
    const adminEmail = $('#adminEmail');
    const adminPass = $('#adminPass');
    const btnAdminLogin = $('#btnAdminLogin');

    const toggleOpen = $('#toggleOpen');
    const lock1 = $('#lock1');
    const lock2 = $('#lock2');
    const searchName = $('#searchName');
    const adminList = $('#adminList');
    const btnWipeDay = $('#btnWipeDay');

    // User self-cancel
    const btnFindMine = $('#btnFindMine');
    const myList = $('#myList');
    const mineCount = $('#mineCount');

    // ===== State =====
    let selectedPC = 'PC-1';
    let adminSession = null;
    let clickBusy = false; // prevents rapid double click

    datePicker.value = todayStr();

    // ===== Backend calls =====
    async function getReservations(date){
      const { data, error } = await supa.from('reservations').select('*').eq('date', date);
      if(error) throw error; return data || [];
    }
    async function getControls(){
      const { data, error } = await supa.from('controls').select('*').eq('id',1).single();
      if(error) throw error; return data;
    }

    async function rpcReserve({ in_date, in_pc, in_start_iso, in_end_iso, in_name, in_pass_hash }){
      const { error } = await supa.rpc('reserve_slot', { in_date, in_pc, in_start_iso, in_end_iso, in_name, in_pass_hash });
      if (error) throw error;
    }
    async function rpcCancelByOwner({ in_id, in_name, in_pass_hash }){
  const { error } = await supa.rpc('cancel_slot_by_owner', { in_id, in_name, in_pass_hash });
  if (error) throw error;
}

    async function rpcAdmin(action, payload){
      if (!adminSession) throw new Error('Admin not logged in');

      if (action === 'setControls') {
        const { error } = await supa.rpc('admin_set_controls', payload);
        if (error) throw error; return;
      }
      if (action === 'removeReservation') {
        const { error } = await supa.rpc('admin_remove_reservation', payload);
        if (error) throw error; return;
      }
      if (action === 'clearDay') {
        const { error } = await supa.rpc('admin_clear_day', payload);
        if (error) throw error; return;
      }
    }

    // ===== Slots/Render =====
    function generateSlots(date){
      const len = Number(slotLenSel.value);
      const sH = Number(startHourInp.value); // may be fractional (e.g., 9.5)
      const eH = Number(endHourInp.value);
      const slots=[];
      for(let h=sH; h<eH; h+=len/60){
        const hour = Math.floor(h);
        const minute = Math.round((h - hour) * 60);
        const startISO = mkISO(date, hour, minute);
        const endDt = new Date(startISO);
        endDt.setMinutes(endDt.getMinutes()+len);
        const endISO = endDt.toISOString();
        slots.push({startISO, endISO});
      }
      return slots;
    }
    function slotLabel(startISO, endISO){
      const s=new Date(startISO), e=new Date(endISO);
      const f=(d)=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return `${f(s)}–${f(e)}`;
    }
    function maskName(name){
      if(!name) return ''; if(name.length<=2) return name[0]+"*";
      return name[0] + '*'.repeat(Math.max(1,name.length-2)) + name[name.length-1];
    }
    function listByPC(resvs, pc){
      return resvs.filter(r=>r.pc===pc).sort((a,b)=>a.start_iso.localeCompare(b.start_iso));
    }

    async function reserve(date, pc, sl){
      if (clickBusy) return;
      clickBusy = true;
      try{
        const name = nameInp.value.trim();
        const code = codeInp.value.trim();
        if(!name || !code) return alert('Enter your name and passcode first.');
        const pass_hash = await sha256(code);

        await rpcReserve({
          in_date: date,
          in_pc: pc,
          in_start_iso: sl.startISO,
          in_end_iso: sl.endISO,
          in_name: name,
          in_pass_hash: pass_hash
        });
        await render();
        await renderMine(); // update user's list too
      }catch(err){ alert(err.message || 'Error'); }
      finally { clickBusy = false; }
    }

    async function render(){
      const date = datePicker.value;
      const [controls, resvs] = await Promise.all([getControls(), getReservations(date)]);
      openBadge.textContent = controls.open ? 'Open' : 'Closed';
      openBadge.className = 'px-2 py-0.5 text-xs rounded-full ' + (controls.open?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800');
      closedMsg.classList.toggle('hidden', controls.open);

      const slots = generateSlots(date);
      const grids = { 'PC-1': grid1, 'PC-2': grid2 };

      for(const pc of Object.keys(grids)){
        const g = grids[pc]; g.innerHTML='';
        const rByPc = listByPC(resvs, pc);

        for(const sl of slots){
          // compare times in ms
          const r = rByPc.find(x => toMs(x.start_iso) === toMs(sl.startISO));
          const isLocked = (pc==='PC-1'?controls.lock_pc1:controls.lock_pc2);
          const isReserved = !!r;
          const disabled = isLocked || !controls.open || isReserved;

          const btn=document.createElement('button');
          btn.className = [
            'w-full flex items-center justify-between px-3 py-2 rounded-lg border',
            disabled
              ? 'bg-slate-200 border-slate-300 text-slate-500 cursor-not-allowed'
              : 'bg-white border-slate-200 hover:bg-slate-50'
          ].join(' ');
          btn.disabled = disabled;

          btn.innerHTML = `
            <div class="text-left">
              <div class="text-sm font-medium">${slotLabel(sl.startISO, sl.endISO)}</div>
              <div class="text-xs text-slate-500">${pc}${isLocked?' · Locked':''}</div>
            </div>
            ${isReserved
              ? `<div class="text-right"><div class="text-xs">Reserved by <span>${maskName(r.name)}</span></div></div>`
              : `<div class="text-xs text-emerald-700">Available</div>`
            }`;

          if(!disabled){
            btn.addEventListener('click', ()=> reserve(date, pc, sl));
          }
          g.appendChild(btn);
        }
      }
    }

    // ===== User self-cancel list =====
    async function renderMine(){
      myList.innerHTML = '';
      mineCount.textContent = '';
      const date = datePicker.value;
      const name = (nameInp.value || '').trim();
      const code = (codeInp.value || '').trim();
      if (!name || !code) return; // need both

      const pass_hash = await sha256(code);
      const resvs = await getReservations(date);
      // Only show items that exactly match name + pass_hash
      const mine = resvs
        .filter(r => r.name === name && r.pass_hash === pass_hash)
        .sort((a,b)=> a.pc.localeCompare(b.pc) || a.start_iso.localeCompare(b.start_iso));

      mineCount.textContent = mine.length ? `${mine.length} found` : 'None found';

      for(const r of mine){
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between py-2';
        row.innerHTML = `
          <div><b>${r.pc}</b> · ${slotLabel(r.start_iso, r.end_iso)}</div>
          <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-500">Cancel</button>
        `;
        row.lastChild.addEventListener('click', async ()=>{
  try{
    const nameNow = (nameInp.value || '').trim();
    const codeNow = (codeInp.value || '').trim();
    if (!nameNow || !codeNow) return alert('Enter your name and passcode above first.');
    const pass_hash = await sha256(codeNow);

    await rpcCancelByOwner({ in_id: r.id, in_name: nameNow, in_pass_hash: pass_hash });
    await render();      // refresh grids
    await renderMine();  // refresh own list
  }catch(e){
    alert(e.message || 'Cancel failed');
    console.error(e);
  }
});

        myList.appendChild(row);
      }
    }

    $('#btnFindMine').addEventListener('click', renderMine);

    // ===== Admin UI =====
    const renderAdminList = async ()=>{
      const date = datePicker.value;
      const resvs = await getReservations(date);
      const q = (searchName.value||'').toLowerCase();
      const rows = resvs
        .filter(r=>!q || r.name.toLowerCase().includes(q))
        .sort((a,b)=> a.pc.localeCompare(b.pc) || a.start_iso.localeCompare(b.start_iso));
      adminList.innerHTML='';
      for(const r of rows){
        const div = document.createElement('div');
        div.className='flex items-center justify-between border-b border-slate-100 py-1.5';
        div.innerHTML = `<div><b>${r.pc}</b> · ${slotLabel(r.start_iso, r.end_iso)} · ${maskName(r.name)}</div>`+
                        `<button class="px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-500">Remove</button>`;
        div.lastChild.addEventListener('click', async ()=>{
          try{
            await rpcAdmin('removeReservation', { in_id: r.id });
            await renderAdminList(); await render(); await renderMine();
          }catch(e){ alert(e.message); }
        });
        adminList.appendChild(div);
      }
    };

    btnAdmin.addEventListener('click', async ()=>{
      const { data } = await supa.auth.getSession();
      adminSession = data.session || null;
      adminModal.classList.remove('hidden'); adminModal.classList.add('flex');
      adminLogin.classList.toggle('hidden', !!adminSession);
      adminPanel.classList.toggle('hidden', !adminSession);
      if (adminSession) {
        try {
          const c = await getControls();
          toggleOpen.checked = !!c.open; lock1.checked = !!c.lock_pc1; lock2.checked = !!c.lock_pc2;
          await renderAdminList();
        } catch (e) {}
      }
    });
    closeAdmin.addEventListener('click', ()=>{
      adminModal.classList.add('hidden'); adminModal.classList.remove('flex');
    });
    btnAdminLogin.addEventListener('click', async ()=>{
      try{
        const { data, error } = await supa.auth.signInWithPassword({ email: adminEmail.value, password: adminPass.value });
        if(error) throw error;
        adminSession = data.session;
        adminLogin.classList.add('hidden'); adminPanel.classList.remove('hidden');
        const c = await getControls();
        toggleOpen.checked = !!c.open; lock1.checked = !!c.lock_pc1; lock2.checked = !!c.lock_pc2;
        await renderAdminList();
      }catch(err){ alert(err.message||'Login failed'); }
    });

    const applyControlsChange = async ()=>{
      try{
        await rpcAdmin('setControls', {
          in_open: toggleOpen.checked,
          in_lock1: lock1.checked,
          in_lock2: lock2.checked
        });
        await render(); await renderAdminList(); await renderMine();
      }catch(e){ alert(e.message); }
    };
    toggleOpen.addEventListener('change', applyControlsChange);
    lock1.addEventListener('change', applyControlsChange);
    lock2.addEventListener('change', applyControlsChange);

    searchName && searchName.addEventListener('input', renderAdminList);
    btnWipeDay.addEventListener('click', async ()=>{
      const date = datePicker.value;
      if(!confirm('Clear all reservations on '+date+'?')) return;
      try{
        await rpcAdmin('clearDay', { in_date: date });
        await renderAdminList(); await render(); await renderMine();
      }catch(e){ alert(e.message); }
    });

    supa.auth.onAuthStateChange((_event, session)=>{ adminSession = session; });

    // init
    $$('.pcBtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        selectedPC = b.dataset.pc;
        $$('.pcBtn').forEach(x=>x.classList.remove('bg-slate-900','text-white'));
        b.classList.add('bg-slate-900','text-white');
      });
    });
    $$('.pcBtn')[0].click();

    regenBtn.addEventListener('click', ()=>{ render(); renderMine(); });
    datePicker.addEventListener('change', ()=>{ render(); renderMine(); });
    nameInp.addEventListener('input', ()=>{ /* don’t auto-search to avoid hash churn */ });

    // first render
    render();
  </script>
</body>
</html>
